
본 문서는 콘서트 예약 시스템 과제 수행 과정에서 구현한 **Redis 기반
분산락, 동시성 제어, 통합 테스트** 내용을 정리한 문서입니다.

------------------------------------------------------------------------

## 📌 1. 프로젝트 목표

-   Redis 기반 분산락 직접 구현
-   좌석 예약 / 잔액 차감 동시성 문제 해결
-   DB Transaction과 혼용 시 안정성 확보
-   멀티스레드 통합 테스트 작성

------------------------------------------------------------------------

## 📌 2. 전체 구조

    io.hhplus.concert
     └ application
         ├ seat
         │   └ HoldSeatUseCase
         ├ balance
         │   └ DeductBalanceUseCase
     └ infrastructure
         ├ persistence
         │   └ seat / balance
         └ redis
             └ RedisLockManager

------------------------------------------------------------------------

## 📌 3. 분산락 설계

### 3.1 Lock Key 설계

도메인      Key 형식
  ----------- -----------------------------
좌석 예약   lock:seat:{dateId}:{seatNo}
잔액 차감   lock:balance:user:{userId}

------------------------------------------------------------------------

### 3.2 Lock 범위

    락 획득 → DB 상태 변경 → 커밋 → 락 해제

------------------------------------------------------------------------

### 3.3 TTL 정책

``` java
private static final long LOCK_TTL_MS = 3000;
```

------------------------------------------------------------------------

## 📌 4. RedisLockManager 구현

-   SET NX PX 기반 락 획득
-   UUID 기반 토큰 사용
-   Lua Script 기반 안전 해제
-   Backoff 재시도 지원

------------------------------------------------------------------------

## 📌 5. 좌석 예약 동시성 처리

1.  Redis 락 획득
2.  DB 조건부 UPDATE 실행
3.  트랜잭션 커밋
4.  락 해제

------------------------------------------------------------------------

## 📌 6. 잔액 차감 동시성 처리

-   사용자 단위 락 적용
-   조건부 차감 쿼리 사용
-   재시도 기반 락 획득

------------------------------------------------------------------------

## 📌 7. 통합 테스트

-   ExecutorService + CountDownLatch
-   50\~100 Thread 동시 실행
-   성공 건수 검증

------------------------------------------------------------------------

## 📌 8. 테스트 데이터 초기화 전략

``` java
seat.resetToAvailableForTest();
```

------------------------------------------------------------------------

## 📌 9. DB Transaction + Redis 혼용 전략

계층    역할
  ------- -------------
Redis   진입 제어
DB Tx   정합성 보장

------------------------------------------------------------------------

## 📌 10. 성과 및 개선 효과

-   중복 예약 차단
-   데이터 무결성 보장
-   안정적 동시 처리

------------------------------------------------------------------------

## 📌 11. 핵심 학습 내용

✔ Redis 분산락 직접 구현\
✔ Lua Script 기반 안전 해제\
✔ Backoff 재시도 전략\
✔ DB + Redis 이중 보호 구조\
✔ 동시성 테스트 작성 경험

------------------------------------------------------------------------

## 📌 12. 향후 개선 방향

-   AOP 기반 Distributed Lock
-   Redisson 비교
-   캐시 전략
-   부하 테스트

------------------------------------------------------------------------

## ✅ 결론

본 과제를 통해 분산 환경 동시성 문제를 Redis와 DB 트랜잭션으로
안정적으로 해결하였다.
